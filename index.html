<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vitals Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f9;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    label, select, input, button {
      display: block;
      margin: 10px 0;
      width: 100%;
      padding: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #eee;
    }
    #login-container, #app-container {
      display: none;
    }
  </style>
</head>
<body>
  <h1>Vitals Tracker</h1>
  <div id="login-container" class="container">
    <h2>Login</h2>
    <button id="login-button">Sign in with Google</button>
  </div>
  <div id="app-container" class="container">
    <label for="patientSelect">Select Patient:</label>
    <select id="patientSelect"></select>

    <label for="dateRangeStart">Start Date:</label>
    <input type="date" id="dateRangeStart">

    <label for="dateRangeEnd">End Date:</label>
    <input type="date" id="dateRangeEnd">

    <button id="downloadPdfButton">Download PDF Report</button>
    <table id="vitalsTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Systolic</th>
          <th>Diastolic</th>
          <th>Pulse</th>
          <th>Oxygen</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const loginButton = document.getElementById('login-button');
    const patientSelect = document.getElementById('patientSelect');
    const dateRangeStart = document.getElementById('dateRangeStart');
    const dateRangeEnd = document.getElementById('dateRangeEnd');
    const downloadPdfButton = document.getElementById('downloadPdfButton');
    const vitalsTableBody = document.querySelector('#vitalsTable tbody');

    // ðŸ”‘ Google Login
    loginButton.addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch((error) => {
        console.error("Login error:", error);
      });
    });

    // Auth state observer
    auth.onAuthStateChanged((user) => {
      if (user) {
        loginContainer.style.display = 'none';
        appContainer.style.display = 'block';
        loadPatients();
      } else {
        loginContainer.style.display = 'block';
        appContainer.style.display = 'none';
      }
    });

    async function loadPatients() {
      const snapshot = await db.collection("patients").get();
      patientSelect.innerHTML = '';
      snapshot.forEach(doc => {
        const option = document.createElement("option");
        option.value = doc.id;
        option.textContent = doc.data().name;
        patientSelect.appendChild(option);
      });
      if (patientSelect.value) {
        loadVitals(patientSelect.value);
      }
    }

    patientSelect.addEventListener('change', () => {
      if (patientSelect.value) {
        loadVitals(patientSelect.value);
      }
    });

    dateRangeStart.addEventListener('change', () => {
      if (patientSelect.value) loadVitals(patientSelect.value);
    });

    dateRangeEnd.addEventListener('change', () => {
      if (patientSelect.value) loadVitals(patientSelect.value);
    });

    async function loadVitals(patientId) {
      vitalsTableBody.innerHTML = '';
      let startDate = dateRangeStart.value ? new Date(dateRangeStart.value + 'T00:00:00') : null;
      let endDate = dateRangeEnd.value ? new Date(dateRangeEnd.value + 'T23:59:59') : null;

      const snapshot = await db.collection("patients").doc(patientId).collection("vitals").get();
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.timestamp) {
          const ts = data.timestamp.toDate();
          if ((!startDate || ts >= startDate) && (!endDate || ts <= endDate)) {
            const row = vitalsTableBody.insertRow();
            row.insertCell().textContent = ts.toLocaleString();
            row.insertCell().textContent = data.systolic || '';
            row.insertCell().textContent = data.diastolic || '';
            row.insertCell().textContent = data.pulse || '';
            row.insertCell().textContent = data.oxygen || '';
          }
        }
      });
    }

    // ðŸ“„ Fixed PDF generation (no duplicates, preserves date range logic)
    downloadPdfButton.addEventListener('click', async () => {
      const patientId = patientSelect.value;
      if (!patientId) return;

      const patientName = patientSelect.options[patientSelect.selectedIndex].text;
      const startDate = dateRangeStart.value ? new Date(dateRangeStart.value + 'T00:00:00') : null;
      const endDate = dateRangeEnd.value ? new Date(dateRangeEnd.value + 'T23:59:59') : null;

      const snapshot = await db.collection("patients").doc(patientId).collection("vitals").get();
      const records = [];
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        if (data.timestamp) {
          const ts = data.timestamp.toDate();
          if ((!startDate || ts >= startDate) && (!endDate || ts <= endDate)) {
            records.push(data);
          }
        }
      });

      if (records.length === 0) {
        alert("No records found for this date range.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text(`Patient Report: ${patientName}`, 14, 20);
      doc.setFontSize(12);
      doc.text(
        `Date Range: ${startDate ? startDate.toLocaleDateString() : 'beginning'} to ${endDate ? endDate.toLocaleDateString() : 'now'}`,
        14,
        30
      );

      const rows = records.map(r => [
        r.timestamp?.toDate().toLocaleString() || "",
        r.systolic || "",
        r.diastolic || "",
        r.pulse || "",
        r.oxygen || ""
      ]);

      doc.autoTable({
        head: [["Date", "Systolic", "Diastolic", "Pulse", "Oxygen"]],
        body: rows,
        startY: 40,
      });

      // ðŸ”’ Save exactly once
      doc.save(`${patientName}_Report.pdf`);
    });
  </script>
</body>
</html>
