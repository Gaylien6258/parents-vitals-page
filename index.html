<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitals Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf-autotable.min.js"></script>
</head>
<body>
    <div id="loading" class="screen">Loading...</div>
    <div id="pdf-loading" class="screen" style="display: none;">Generating PDF...</div>
    <div id="error" class="screen" style="display: none; color: red;"></div>

    <div class="screen" id="auth" style="display: none;">
        <div class="auth-card">
            <h2>Please sign in</h2>
            <button id="google-login-button" class="google-btn">Sign In with Google</button>
        </div>
    </div>

    <div class="screen" id="app" style="display: none;">
        <div class="header">
            <h1>Vitals Tracker</h1>
            <button id="logout-button" class="logout-btn">Logout</button>
        </div>

        <div class="content-container">
            <div class="data-entry-card">
                <h2>Record Vitals</h2>
                <form id="vitals-form">
                    <div class="input-group">
                        <label for="patient-select">Patient:</label>
                        <select id="patient-select" required>
                            <option value="Mom">Mom</option>
                            <option value="Dad">Dad</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="systolic">Systolic BP (mmHg):</label>
                        <input type="number" id="systolic" placeholder="Systolic" min="0" max="300">
                    </div>
                    <div class="input-group">
                        <label for="diastolic">Diastolic BP (mmHg):</label>
                        <input type="number" id="diastolic" placeholder="Diastolic" min="0" max="200">
                    </div>
                    <div class="input-group">
                        <label for="heartrate">Heart Rate (bpm):</label>
                        <input type="number" id="heartrate" placeholder="Heart Rate" min="0" max="200">
                    </div>
                    <div class="input-group">
                        <label for="oxygen">Oxygen Saturation (%):</label>
                        <input type="number" id="oxygen" placeholder="Oxygen Saturation" min="0" max="100">
                    </div>
                    <div class="input-group">
                        <label for="glucose">Blood Glucose (mg/dL):</label>
                        <input type="number" id="glucose" placeholder="Blood Glucose" min="0" max="500">
                    </div>
                    <div class="input-group">
                        <label for="timestamp-input">Date and Time:</label>
                        <input type="datetime-local" id="timestamp-input" required>
                    </div>
                    <button type="submit" id="submit-btn" class="submit-btn">Add Vitals</button>
                    <button type="button" id="update-btn" class="submit-btn" style="display: none;">Update Vitals</button>
                    <button type="button" id="cancel-edit-btn" class="submit-btn" style="display: none;">Cancel</button>
                </form>
            </div>

            <div class="data-view-card">
                <h2>Vitals Over Time</h2>
                <div class="input-group">
                    <label for="date-range-start">Start Date:</label>
                    <input type="date" id="date-range-start">
                </div>
                <div class="input-group">
                    <label for="date-range-end">End Date:</label>
                    <input type="date" id="date-range-end">
                </div>
                <button id="download-pdf" class="download-btn">Download PDF Report</button>
                <ul id="vitals-list"></ul>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <p id="confirm-message"></p>
            <div class="modal-buttons">
                <button id="confirm-yes-btn" class="modal-btn yes">Yes</button>
                <button id="confirm-no-btn" class="modal-btn no">No</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, orderBy, getDocs, Timestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDWKz6O-5xir46vivUPBAse_vMSaXWKamU",
            authDomain: "parents-vitals-data.firebaseapp.com",
            projectId: "parents-vitals-data",
            storageBucket: "parents-vitals-data.firebasestorage.app",
            messagingSenderId: "34332288387",
            appId: "1:34332288387:web:ea67be6bb564e8f402c2b6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const authDiv = document.getElementById('auth');
        const appDiv = document.getElementById('app');
        const pdfLoadingDiv = document.getElementById('pdf-loading');

        const vitalsForm = document.getElementById('vitals-form');
        const patientSelect = document.getElementById('patient-select');
        const systolicInput = document.getElementById('systolic');
        const diastolicInput = document.getElementById('diastolic');
        const heartrateInput = document.getElementById('heartrate');
        const oxygenInput = document.getElementById('oxygen');
        const glucoseInput = document.getElementById('glucose');
        const timestampInput = document.getElementById('timestamp-input');
        const vitalsList = document.getElementById('vitals-list');
        const dateRangeStart = document.getElementById('date-range-start');
        const dateRangeEnd = document.getElementById('date-range-end');
        const downloadPdfButton = document.getElementById('download-pdf');
        const submitBtn = document.getElementById('submit-btn');
        const updateBtn = document.getElementById('update-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const logoutButton = document.getElementById('logout-button');
        const googleLoginButton = document.getElementById('google-login-button');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        let currentUserId = null;
        let docIdToEdit = null;
        let docIdToDelete = null;

        const patientNames = { "Mom": "Susan", "Dad": "Gary" };

        function validateInputs(s, d, h, o, g) {
            if (s && (s<0||s>300)) return false;
            if (d && (d<0||d>200)) return false;
            if (h && (h<0||h>200)) return false;
            if (o && (o<0||o>100)) return false;
            if (g && (g<0||g>500)) return false;
            return true;
        }

        function displayVitals(data) {
            vitalsList.innerHTML = '';
            const filtered = data.filter(v => v.patient === patientSelect.value);
            filtered.forEach(vital => {
                const li = document.createElement('li');
                li.innerHTML = `
                    ${patientNames[vital.patient] || vital.patient} - ${vital.timestamp.toDate().toLocaleString()}:
                    BP: ${vital.systolic || '-'} / ${vital.diastolic || '-'} mmHg,
                    HR: ${vital.heartrate || '-'} bpm,
                    O2: ${vital.oxygen || '-'}%,
                    Glucose: ${vital.glucose || '-'} mg/dL
                    <div>
                        <button class="edit-btn">Edit</button>
                        <button class="delete-btn">Delete</button>
                    </div>`;
                vitalsList.appendChild(li);

                li.querySelector('.edit-btn').addEventListener('click', async () => {
                    docIdToEdit = vital.id;
                    patientSelect.value = vital.patient;
                    systolicInput.value = vital.systolic || '';
                    diastolicInput.value = vital.diastolic || '';
                    heartrateInput.value = vital.heartrate || '';
                    oxygenInput.value = vital.oxygen || '';
                    glucoseInput.value = vital.glucose || '';
                    timestampInput.value = vital.timestamp.toDate().toISOString().slice(0,16);
                    submitBtn.style.display='none';
                    updateBtn.style.display='block';
                    cancelEditBtn.style.display='block';
                });

                li.querySelector('.delete-btn').addEventListener('click', () => {
                    docIdToDelete = vital.id;
                    confirmMessage.textContent='Are you sure you want to delete this entry?';
                    confirmModal.style.display='flex';
                });
            });
        }

        function filterDataByDate(data) {
            const start = dateRangeStart.value ? new Date(dateRangeStart.value) : null;
            const end = dateRangeEnd.value ? new Date(dateRangeEnd.value) : null;
            return data.filter(v => {
                const t = v.timestamp.toDate();
                if(start && t<start) return false;
                if(end && t>end) return false;
                return true;
            });
        }

        function generatePDF(data) {
            pdfLoadingDiv.style.display='flex';
            const doc = new window.jspdf.jsPDF();
            doc.setFontSize(20);
            doc.text(`Vitals Report: ${patientNames[patientSelect.value]}`, 20, 20);
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);

            const tableData = data.map(v => [
                v.timestamp.toDate().toLocaleString(),
                v.systolic ? `${v.systolic}/${v.diastolic || '-'}` : '-',
                v.heartrate || '-',
                v.oxygen || '-',
                v.glucose || '-'
            ]);

            doc.autoTable({
                head:[['Date','BP','Heart Rate','Oxygen','Glucose']],
                body: tableData,
                startY:40,
                styles:{fontSize:10}
            });

            setTimeout(()=>{doc.save('vitals-report.pdf'); pdfLoadingDiv.style.display='none';},500);
        }

        function logout(){
            signOut(auth);
            appDiv.style.display='none';
            authDiv.style.display='flex';
        }

        vitalsForm.addEventListener('submit', async e=>{
            e.preventDefault();
            const s=parseInt(systolicInput.value)||null;
            const d=parseInt(diastolicInput.value)||null;
            const h=parseInt(heartrateInput.value)||null;
            const o=parseInt(oxygenInput.value)||null;
            const g=parseInt(glucoseInput.value)||null;
            const ts=new Date(timestampInput.value);
            if(!validateInputs(s,d,h,o,g)){errorDiv.textContent='Invalid values'; errorDiv.style.display='block'; return;}
            try{
                await addDoc(collection(db,'users',currentUserId,'vitals'),{
                    patient:patientSelect.value,systolic:s,diastolic:d,heartrate:h,oxygen:o,glucose:g,timestamp:Timestamp.fromDate(ts)
                });
                vitalsForm.reset();
                errorDiv.style.display='none';
                patientSelect.dispatchEvent(new Event('change'));
            }catch(err){errorDiv.textContent='Error: '+err.message; errorDiv.style.display='block';}
        });

        updateBtn.addEventListener('click',async()=>{
            const s=parseInt(systolicInput.value)||null;
            const d=parseInt(diastolicInput.value)||null;
            const h=parseInt(heartrateInput.value)||null;
            const o=parseInt(oxygenInput.value)||null;
            const g=parseInt(glucoseInput.value)||null;
            const ts=new Date(timestampInput.value);
            if(!validateInputs(s,d,h,o,g)){errorDiv.textContent='Invalid values'; errorDiv.style.display='block'; return;}
            try{
                await updateDoc(doc(db,'users',currentUserId,'vitals',docIdToEdit),{
                    patient:patientSelect.value,systolic:s,diastolic:d,heartrate:h,oxygen:o,glucose:g,timestamp:Timestamp.fromDate(ts)
                });
                vitalsForm.reset(); submitBtn.style.display='block'; updateBtn.style.display='none'; cancelEditBtn.style.display='none'; docIdToEdit=null;
                errorDiv.style.display='none'; patientSelect.dispatchEvent(new Event('change'));
            }catch(err){errorDiv.textContent='Error updating vitals: '+err.message; errorDiv.style.display='block';}
        });

        cancelEditBtn.addEventListener('click',()=>{vitalsForm.reset(); submitBtn.style.display='block'; updateBtn.style.display='none'; cancelEditBtn.style.display='none'; docIdToEdit=null;});

        confirmYesBtn.addEventListener('click',async()=>{
            if(!docIdToDelete) return;
            await deleteDoc(doc(db,'users',currentUserId,'vitals',docIdToDelete));
            docIdToDelete=null; confirmModal.style.display='none'; patientSelect.dispatchEvent(new Event('change'));
        });

        confirmNoBtn.addEventListener('click',()=>{confirmModal.style.display='none'; docIdToDelete=null;});

        patientSelect.addEventListener('change',async()=>{
            const q= query(collection(db,'users',currentUserId,'vitals'),orderBy('timestamp','desc'));
            const snapshot=await getDocs(q);
            let data=snapshot.docs.map(d=>({id:d.id,...d.data()}));
            data=filterDataByDate(data);
            displayVitals(data);
        });

        dateRangeStart.addEventListener('change',()=>{patientSelect.dispatchEvent(new Event('change'));});
        dateRangeEnd.addEventListener('change',()=>{patientSelect.dispatchEvent(new Event('change'));});

        downloadPdfButton.addEventListener('click',async()=>{
            const q= query(collection(db,'users',currentUserId,'vitals'),orderBy('timestamp','desc'));
            const snapshot=await getDocs(q);
            let data=snapshot.docs.map(d=>({id:d.id,...d.data()}));
            data = filterDataByDate(data).filter(v=>v.patient===patientSelect.value);
            generatePDF(data);
        });

        logoutButton.addEventListener('click',logout);

        googleLoginButton.addEventListener('click',()=>{
            const provider=new GoogleAuthProvider();
            signInWithPopup(auth,provider).catch(err=>{errorDiv.textContent='Login failed: '+err.message; errorDiv.style.display='block';});
        });

        onAuthStateChanged(auth,user=>{
            loadingDiv.style.display='none';
            if(user){
                currentUserId=user.uid;
                authDiv.style.display='none';
                appDiv.style.display='block';
                patientSelect.dispatchEvent(new Event('change'));
            }else{
                appDiv.style.display='none';
                authDiv.style.display='flex';
            }
        });

    </script>
</body>
</html>
