<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitals Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf-autotable.min.js"></script>
</head>
<body>
    <div id="loading" class="screen">Loading...</div>
    <div id="pdf-loading" class="screen" style="display: none;">Generating PDF...</div>

    <div class="screen" id="auth" style="display: none;">
        <div class="auth-card">
            <h2>Please sign in</h2>
            <button id="google-login-button" class="google-btn">Sign In with Google</button>
        </div>
    </div>

    <div class="screen" id="app" style="display: none;">
        <div class="header">
            <h1>Vitals Tracker</h1>
            <button id="logout-button" class="logout-btn">Logout</button>
        </div>
        <div id="user-id-display"></div>

        <div class="content-container">
            <div class="data-entry-card">
                <h2>Record Vitals</h2>
                <form id="vitals-form">
                    <div class="input-group">
                        <label for="patient-select">Patient:</label>
                        <select id="patient-select">
                            <option value="Mom">Mom</option>
                            <option value="Dad">Dad</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="systolic">Systolic BP (mmHg):</label>
                        <input type="number" id="systolic" placeholder="Systolic" min="0" max="300">
                    </div>
                    <div class="input-group">
                        <label for="diastolic">Diastolic BP (mmHg):</label>
                        <input type="number" id="diastolic" placeholder="Diastolic" min="0" max="200">
                    </div>
                    <div class="input-group">
                        <label for="heartrate">Heart Rate (bpm):</label>
                        <input type="number" id="heartrate" placeholder="Heart Rate" min="0" max="200">
                    </div>
                    <div class="input-group">
                        <label for="oxygen">Oxygen Saturation (%):</label>
                        <input type="number" id="oxygen" placeholder="Oxygen Saturation" min="0" max="100">
                    </div>
                    <div class="input-group">
                        <label for="glucose">Blood Glucose (mg/dL):</label>
                        <input type="number" id="glucose" placeholder="Blood Glucose" min="0" max="500">
                    </div>
                    <div class="input-group">
                        <label for="timestamp-input">Date and Time:</label>
                        <input type="datetime-local" id="timestamp-input">
                    </div>
                    <button type="submit" id="submit-btn" class="submit-btn">Add Vitals</button>
                    <button type="button" id="update-btn" class="submit-btn" style="display: none;">Update Vitals</button>
                    <button type="button" id="cancel-edit-btn" class="submit-btn" style="display: none;">Cancel</button>
                </form>
            </div>
            <div class="data-view-card">
                <h2>Vitals Over Time</h2>
                <div class="chart-container">
                    <canvas id="vitals-chart"></canvas>
                </div>
                <h2>Recent Readings</h2>
                <div class="input-group">
                    <label for="date-range-start">Start Date:</label>
                    <input type="date" id="date-range-start">
                </div>
                <div class="input-group">
                    <label for="date-range-end">End Date:</label>
                    <input type="date" id="date-range-end">
                </div>
                <button id="download-pdf" class="download-btn">Download PDF Report</button>
                <ul id="vitals-list"></ul>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <p id="confirm-message"></p>
            <div class="modal-buttons">
                <button id="confirm-yes-btn" class="modal-btn yes">Yes</button>
                <button id="confirm-no-btn" class="modal-btn no">No</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDWKz6O-5xir46vivUPBAse_vMSaXWKamU",
            authDomain: "parents-vitals-data.firebaseapp.com",
            projectId: "parents-vitals-data",
            storageBucket: "parents-vitals-data.firebasestorage.app",
            messagingSenderId: "34332288387",
            appId: "1:34332288387:web:ea67be6bb564e8f402c2b6"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const { jsPDF } = window.jspdf;

        const loadingDiv = document.getElementById('loading');
        const authDiv = document.getElementById('auth');
        const appDiv = document.getElementById('app');
        const pdfLoadingDiv = document.getElementById('pdf-loading');
        const vitalsForm = document.getElementById('vitals-form');
        const patientSelect = document.getElementById('patient-select');
        const systolicInput = document.getElementById('systolic');
        const diastolicInput = document.getElementById('diastolic');
        const heartrateInput = document.getElementById('heartrate');
        const oxygenInput = document.getElementById('oxygen');
        const glucoseInput = document.getElementById('glucose');
        const timestampInput = document.getElementById('timestamp-input');
        const vitalsList = document.getElementById('vitals-list');
        const downloadPdfButton = document.getElementById('download-pdf');
        const submitBtn = document.getElementById('submit-btn');
        const updateBtn = document.getElementById('update-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const logoutButton = document.getElementById('logout-button');
        const googleLoginButton = document.getElementById('google-login-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        const dateRangeStart = document.getElementById('date-range-start');
        const dateRangeEnd = document.getElementById('date-range-end');

        let docIdToEdit = null;
        let docIdToDelete = null;
        let vitalsChart = null;
        let currentUserId = null;

        const patientNames = { "Mom": "Susan", "Dad": "Gary" };

        function validateInputs(systolic, diastolic, heartrate, oxygen, glucose) {
            if (systolic && (systolic < 0 || systolic > 300)) return false;
            if (diastolic && (diastolic < 0 || diastolic > 200)) return false;
            if (heartrate && (heartrate < 0 || heartrate > 200)) return false;
            if (oxygen && (oxygen < 0 || oxygen > 100)) return false;
            if (glucose && (glucose < 0 || glucose > 500)) return false;
            return true;
        }

        function logout() {
            auth.signOut().then(() => {
                appDiv.style.display = 'none';
                authDiv.style.display = 'flex';
                currentUserId = null;
                userIdDisplay.textContent = '';
                if (vitalsChart) vitalsChart.destroy();
            }).catch(error => {
                alert('Logout failed: ' + error.message);
            });
        }

        function updateChart(data) {
            if (vitalsChart) vitalsChart.destroy();
            const ctx = document.getElementById('vitals-chart').getContext('2d');
            vitalsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Heart Rate (bpm)',
                            data: data.map(d => ({ x: d.timestamp.toDate(), y: d.heartrate || null })),
                            borderColor: '#4f46e5',
                            fill: false
                        },
                        {
                            label: 'Oxygen Saturation (%)',
                            data: data.map(d => ({ x: d.timestamp.toDate(), y: d.oxygen || null })),
                            borderColor: '#10b981',
                            fill: false
                        },
                        {
                            label: 'Blood Glucose (mg/dL)',
                            data: data.map(d => ({ x: d.timestamp.toDate(), y: d.glucose || null })),
                            borderColor: '#f59e0b',
                            fill: false
                        }
                    ]
                },
                options: {
                    scales: {
                        x: { type: 'time', time: { unit: 'day' } },
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function displayVitals(data) {
            vitalsList.innerHTML = '';
            data.forEach(doc => {
                const vital = doc.data();
                const li = document.createElement('li');
                li.innerHTML = `
                    ${patientNames[vital.patient] || vital.patient} - 
                    ${vital.timestamp.toDate().toLocaleString()}: 
                    BP: ${vital.systolic || '-'} / ${vital.diastolic || '-'} mmHg, 
                    HR: ${vital.heartrate || '-'} bpm, 
                    O2: ${vital.oxygen || '-'}%, 
                    Glucose: ${vital.glucose || '-'} mg/dL
                    <div>
                        <button class="edit-btn" data-id="${doc.id}">Edit</button>
                        <button class="delete-btn" data-id="${doc.id}">Delete</button>
                    </div>
                `;
                vitalsList.appendChild(li);
            });

            vitalsList.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    docIdToEdit = btn.dataset.id;
                    db.collection('vitals').doc(docIdToEdit).get().then(doc => {
                        const data = doc.data();
                        patientSelect.value = data.patient;
                        systolicInput.value = data.systolic || '';
                        diastolicInput.value = data.diastolic || '';
                        heartrateInput.value = data.heartrate || '';
                        oxygenInput.value = data.oxygen || '';
                        glucoseInput.value = data.glucose || '';
                        timestampInput.value = data.timestamp.toDate().toISOString().slice(0, 16);
                        submitBtn.style.display = 'none';
                        updateBtn.style.display = 'block';
                        cancelEditBtn.style.display = 'block';
                    });
                });
            });

            vitalsList.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    docIdToDelete = btn.dataset.id;
                    confirmMessage.textContent = 'Are you sure you want to delete this entry?';
                    confirmModal.style.display = 'flex';
                });
            });
        }

        function generatePDF(data) {
            pdfLoadingDiv.style.display = 'flex';
            const doc = new jsPDF();
            doc.setFontSize(20);
            doc.text('Vitals Report', 20, 20);
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 30);

            const tableData = data.map(vital => [
                patientNames[vital.patient] || vital.patient,
                vital.timestamp.toDate().toLocaleString(),
                vital.systolic ? `${vital.systolic}/${vital.diastolic || '-'}` : '-',
                vital.heartrate || '-',
                vital.oxygen || '-',
                vital.glucose || '-'
            ]);

            doc.autoTable({
                head: [['Patient', 'Date', 'Blood Pressure (mmHg)', 'Heart Rate (bpm)', 'Oxygen (%)', 'Glucose (mg/dL)']],
                body: tableData,
                startY: 40,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [79, 70, 229] }
            });

            setTimeout(() => {
                doc.save('vitals-report.pdf');
                pdfLoadingDiv.style.display = 'none';
            }, 1000);
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                userIdDisplay.textContent = `Logged in as: ${user.email}`;
                loadingDiv.style.display = 'none';
                authDiv.style.display = 'none';
                appDiv.style.display = 'block';

                const query = db.collection('vitals')
                    .where('userId', '==', currentUserId)
                    .orderBy('timestamp', 'desc');
                query.onSnapshot(snapshot => {
                    const data = [];
                    snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                    displayVitals(data);
                    updateChart(data);
                });
            } else {
                loadingDiv.style.display = 'none';
                authDiv.style.display = 'flex';
                appDiv.style.display = 'none';
            }
        });

        googleLoginButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                alert('Login failed: ' + error.message);
            });
        });

        logoutButton.addEventListener('click', logout);

        vitalsForm.addEventListener('submit', e => {
            e.preventDefault();
            const systolic = parseInt(systolicInput.value) || null;
            const diastolic = parseInt(diastolicInput.value) || null;
            const heartrate = parseInt(heartrateInput.value) || null;
            const oxygen = parseInt(oxygenInput.value) || null;
            const glucose = parseInt(glucoseInput.value) || null;
            const timestamp = timestampInput.value ? new Date(timestampInput.value) : new Date();

            if (!validateInputs(systolic, diastolic, heartrate, oxygen, glucose)) {
                alert('Please enter valid values: Systolic (0-300), Diastolic (0-200), Heart Rate (0-200), Oxygen (0-100), Glucose (0-500).');
                return;
            }

            db.collection('vitals').add({
                userId: currentUserId,
                patient: patientSelect.value,
                systolic,
                diastolic,
                heartrate,
                oxygen,
                glucose,
                timestamp: firebase.firestore.Timestamp.fromDate(timestamp)
            }).then(() => {
                vitalsForm.reset();
            }).catch(error => {
                alert('Error adding vitals: ' + error.message);
            });
        });

        updateBtn.addEventListener('click', () => {
            const systolic = parseInt(systolicInput.value) || null;
            const diastolic = parseInt(diastolicInput.value) || null;
            const heartrate = parseInt(heartrateInput.value) || null;
            const oxygen = parseInt(oxygenInput.value) || null;
            const glucose = parseInt(glucoseInput.value) || null;
            const timestamp = timestampInput.value ? new Date(timestampInput.value) : new Date();

            if (!validateInputs(systolic, diastolic, heartrate, oxygen, glucose)) {
                alert('Please enter valid values: Systolic (0-300), Diastolic (0-200), Heart Rate (0-200), Oxygen (0-100), Glucose (0-500).');
                return;
            }

            db.collection('vitals').doc(docIdToEdit).update({
                patient: patientSelect.value,
                systolic,
                diastolic,
                heartrate,
                oxygen,
                glucose,
                timestamp: firebase.firestore.Timestamp.fromDate(timestamp)
            }).then(() => {
                vitalsForm.reset();
                submitBtn.style.display = 'block';
                updateBtn.style.display = 'none';
                cancelEditBtn.style.display = 'none';
                docIdToEdit = null;
            }).catch(error => {
                alert('Error updating vitals: ' + error.message);
            });
        });

        cancelEditBtn.addEventListener('click', () => {
            vitalsForm.reset();
            submitBtn.style.display = 'block';
            updateBtn.style.display = 'none';
            cancelEditBtn.style.display = 'none';
            docIdToEdit = null;
        });

        confirmYesBtn.addEventListener('click', () => {
            db.collection('vitals').doc(docIdToDelete).delete().then(() => {
                confirmModal.style.display = 'none';
                docIdToDelete = null;
            }).catch(error => {
                alert('Error deleting vital: ' + error.message);
            });
        });

        confirmNoBtn.addEventListener('click', () => {
            confirmModal.style.display = 'none';
            docIdToDelete = null;
        });

        downloadPdfButton.addEventListener('click', () => {
            const startDate = dateRangeStart.value ? new Date(dateRangeStart.value) : null;
            const endDate = dateRangeEnd.value ? new Date(dateRangeEnd.value) : null;
            let query = db.collection('vitals').where('userId', '==', currentUserId).orderBy('timestamp', 'desc');

            if (startDate) {
                query = query.where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(startDate));
            }
            if (endDate) {
                const endDateAdjusted = new Date(endDate);
                endDateAdjusted.setHours(23, 59, 59, 999);
                query = query.where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(endDateAdjusted));
            }

            query.get().then(snapshot => {
                const data = [];
                snapshot.forEach(doc => data.push(doc.data()));
                generatePDF(data);
            }).catch(error => {
                alert('Error generating PDF: ' + error.message);
                pdfLoadingDiv.style.display = 'none';
            });
        });
    </script>
</body>
</html>
