<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vitals Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Roboto', sans-serif; margin:0; padding:0; background:#f4f4f4; }
  .header { display:flex; justify-content:space-between; align-items:center; background:#007ACC; color:white; padding:10px 20px; }
  .header h1 { margin:0; font-size:1.5em; }
  .logout-btn { background:#ff4c4c; color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:4px; }
  .content-container { display:flex; flex-wrap:wrap; padding:20px; gap:20px; }
  .data-entry-card, .data-view-card { background:white; padding:20px; border-radius:8px; flex:1 1 400px; box-shadow:0 2px 5px rgba(0,0,0,0.2); }
  .input-group { margin-bottom:10px; display:flex; flex-direction:column; }
  .input-group label { margin-bottom:3px; }
  input, select { padding:5px; font-size:1em; }
  .submit-btn, .download-btn { margin-top:10px; padding:10px 15px; background:#007ACC; color:white; border:none; cursor:pointer; border-radius:4px; }
  ul#vitals-list { list-style:none; padding:0; max-height:400px; overflow-y:auto; }
  ul#vitals-list li { background:#e8f0fe; margin:5px 0; padding:5px 10px; border-radius:4px; }
  .screen { display:none; padding:20px; text-align:center; font-size:1.2em; }
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  .modal-content { background:white; padding:20px; border-radius:8px; max-width:400px; margin:auto; }
  .modal-buttons { display:flex; justify-content:space-around; margin-top:20px; }
  .modal-btn { padding:8px 15px; cursor:pointer; border:none; border-radius:4px; }
  .yes { background:#28a745; color:white; }
  .no { background:#dc3545; color:white; }
</style>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<div id="loading" class="screen">Loading...</div>
<div id="pdf-loading" class="screen">Generating PDF...</div>
<div id="error" class="screen" style="color:red;"></div>

<div id="auth" class="screen">
  <h2>Please sign in</h2>
  <button id="google-login-button" class="submit-btn">Sign In with Google</button>
</div>

<div id="app" class="screen">
  <div class="header">
    <h1>Vitals Tracker</h1>
    <button id="logout-button" class="logout-btn">Logout</button>
  </div>

  <div class="content-container">
    <div class="data-entry-card">
      <h2>Record Vitals</h2>
      <form id="vitals-form">
        <div class="input-group">
          <label for="patient-select">Patient:</label>
          <select id="patient-select" required>
            <option value="Mom">Mom</option>
            <option value="Dad">Dad</option>
          </select>
        </div>
        <div class="input-group"><label>Systolic BP:</label><input type="number" id="systolic" min="0" max="300"></div>
        <div class="input-group"><label>Diastolic BP:</label><input type="number" id="diastolic" min="0" max="200"></div>
        <div class="input-group"><label>Heart Rate:</label><input type="number" id="heartrate" min="0" max="200"></div>
        <div class="input-group"><label>Oxygen Saturation:</label><input type="number" id="oxygen" min="0" max="100"></div>
        <div class="input-group"><label>Blood Glucose:</label><input type="number" id="glucose" min="0" max="500"></div>
        <div class="input-group"><label>Date and Time:</label><input type="datetime-local" id="timestamp-input" required></div>
        <button type="submit" id="submit-btn" class="submit-btn">Add Vitals</button>
        <button type="button" id="update-btn" class="submit-btn" style="display:none;">Update Vitals</button>
        <button type="button" id="cancel-edit-btn" class="submit-btn" style="display:none;">Cancel</button>
      </form>
    </div>

    <div class="data-view-card">
      <h2>Recent Readings</h2>
      <div class="input-group"><label>Start Date:</label><input type="date" id="date-range-start"></div>
      <div class="input-group"><label>End Date:</label><input type="date" id="date-range-end"></div>
      <button id="download-pdf" class="download-btn">Download PDF Report</button>
      <ul id="vitals-list"></ul>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, orderBy, getDocs, Timestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';
const { jsPDF } = window.jspdf;

const firebaseConfig = {
  apiKey: "AIzaSyDWKz6O-5xir46vivUPBAse_vMSaXWKamU",
  authDomain: "parents-vitals-data.firebaseapp.com",
  projectId: "parents-vitals-data",
  storageBucket: "parents-vitals-data.appspot.com",
  messagingSenderId: "34332288387",
  appId: "1:34332288387:web:ea67be6bb564e8f402c2b6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const loadingDiv = document.getElementById('loading');
const authDiv = document.getElementById('auth');
const appDiv = document.getElementById('app');
const pdfLoadingDiv = document.getElementById('pdf-loading');
const vitalsForm = document.getElementById('vitals-form');
const patientSelect = document.getElementById('patient-select');
const systolicInput = document.getElementById('systolic');
const diastolicInput = document.getElementById('diastolic');
const heartrateInput = document.getElementById('heartrate');
const oxygenInput = document.getElementById('oxygen');
const glucoseInput = document.getElementById('glucose');
const timestampInput = document.getElementById('timestamp-input');
const vitalsList = document.getElementById('vitals-list');
const downloadPdfButton = document.getElementById('download-pdf');
const submitBtn = document.getElementById('submit-btn');
const updateBtn = document.getElementById('update-btn');
const cancelEditBtn = document.getElementById('cancel-edit-btn');
const logoutButton = document.getElementById('logout-button');
const googleLoginButton = document.getElementById('google-login-button');
const dateRangeStart = document.getElementById('date-range-start');
const dateRangeEnd = document.getElementById('date-range-end');

let docIdToEdit = null;
let currentUserId = null;

const patientNames = { "Mom": "Susan", "Dad": "Gary" };

function resetForm(){
  vitalsForm.reset();
  const now = new Date();
  timestampInput.value = now.toISOString().slice(0,16);
  submitBtn.style.display='inline';
  updateBtn.style.display='none';
  cancelEditBtn.style.display='none';
}

async function loadVitals(){
  vitalsList.innerHTML='';
  const selectedPatient=patientSelect.value;
  const vitalsCol = collection(db,'vitals');
  const q = query(vitalsCol, orderBy('timestamp','desc'));
  const snapshot = await getDocs(q);
  const data=[];
  snapshot.forEach(doc=>data.push({id:doc.id,...doc.data()}));
  // filter by patient
  const filteredPatient=data.filter(d=>d.patient===selectedPatient);
  // filter by date
  const start=dateRangeStart.value?new Date(dateRangeStart.value):null;
  const end=dateRangeEnd.value?new Date(dateRangeEnd.value):null;
  const filtered=filteredPatient.filter(d=>{
    const t=d.timestamp.toDate();
    let ok=true;
    if(start) ok=ok && t>=start;
    if(end){ const endAdj=new Date(end); endAdj.setHours(23,59,59,999); ok=ok && t<=endAdj; }
    return ok;
  });
  filtered.forEach(v=>{
    const li=document.createElement('li');
    li.innerHTML=`${patientNames[v.patient]} - ${v.timestamp.toDate().toLocaleString()}: BP ${v.systolic||'-'}/${v.diastolic||'-'}, HR ${v.heartrate||'-'}, O2 ${v.oxygen||'-'}, Glucose ${v.glucose||'-'} <button onclick="editVitals('${v.id}')">Edit</button>`;
    vitalsList.appendChild(li);
  });
}

window.editVitals=async function(id){
  const docRef = doc(db,'vitals',id);
  const d=await getDocs(query(collection(db,'vitals')));
  const snap = await getDocs(docRef);
  const v=snap.data();
  patientSelect.value=v.patient;
  systolicInput.value=v.systolic||'';
  diastolicInput.value=v.diastolic||'';
  heartrateInput.value=v.heartrate||'';
  oxygenInput.value=v.oxygen||'';
  glucoseInput.value=v.glucose||'';
  timestampInput.value=v.timestamp.toDate().toISOString().slice(0,16);
  submitBtn.style.display='none';
  updateBtn.style.display='inline';
  cancelEditBtn.style.display='inline';
  docIdToEdit=id;
};

vitalsForm.addEventListener('submit',async e=>{
  e.preventDefault();
  const data={
    patient:patientSelect.value,
    systolic:parseInt(systolicInput.value)||null,
    diastolic:parseInt(diastolicInput.value)||null,
    heartrate:parseInt(heartrateInput.value)||null,
    oxygen:parseInt(oxygenInput.value)||null,
    glucose:parseInt(glucoseInput.value)||null,
    timestamp: Timestamp.fromDate(new Date(timestampInput.value)),
    userId:currentUserId
  };
  await addDoc(collection(db,'vitals'),data);
  resetForm();
  loadVitals();
});

updateBtn.addEventListener('click',async ()=>{
  const data={
    patient:patientSelect.value,
    systolic:parseInt(systolicInput.value)||null,
    diastolic:parseInt(diastolicInput.value)||null,
    heartrate:parseInt(heartrateInput.value)||null,
    oxygen:parseInt(oxygenInput.value)||null,
    glucose:parseInt(glucoseInput.value)||null,
    timestamp: Timestamp.fromDate(new Date(timestampInput.value))
  };
  await updateDoc(doc(db,'vitals',docIdToEdit),data);
  resetForm();
  loadVitals();
});

cancelEditBtn.addEventListener('click',resetForm);
patientSelect.addEventListener('change',loadVitals);
dateRangeStart.addEventListener('change',loadVitals);
dateRangeEnd.addEventListener('change',loadVitals);

downloadPdfButton.addEventListener('click',async ()=>{
  pdfLoadingDiv.style.display='block';
  const selectedPatient=patientSelect.value;
  const vitalsCol = collection(db,'vitals');
  const q = query(vitalsCol, orderBy('timestamp','desc'));
  const snapshot = await getDocs(q);
  const data=[];
  snapshot.forEach(doc=>data.push({id:doc.id,...doc.data()}));
  // filter patient
  const filtered=data.filter(d=>d.patient===selectedPatient);
  // filter date
  const start=dateRangeStart.value?new Date(dateRangeStart.value):null;
  const end=dateRangeEnd.value?new Date(dateRangeEnd.value):null;
  const finalData=filtered.filter(d=>{
    const t=d.timestamp.toDate();
    let ok=true;
    if(start) ok=ok && t>=start;
    if(end){ const endAdj=new Date(end); endAdj.setHours(23,59,59,999); ok=ok && t<=endAdj; }
    return ok;
  });
  const docPDF=new jsPDF();
  docPDF.setFontSize(18);
  docPDF.text(`${patientNames[selectedPatient]}'s Vitals Report`,14,22);
  docPDF.setFontSize(12);
  const rows=finalData.map(d=>[d.timestamp.toDate().toLocaleString(), d.systolic||'-',d.diastolic||'-',d.heartrate||'-',d.oxygen||'-',d.glucose||'-']);
  docPDF.autoTable({head:[['Date/Time','Systolic','Diastolic','HR','O2','Glucose']],body:rows,startY:30});
  docPDF.save(`${patientNames[selectedPatient]}-Vitals.pdf`);
  pdfLoadingDiv.style.display='none';
});

googleLoginButton.addEventListener('click',()=>signInWithPopup(auth,provider));
logoutButton.addEventListener('click',()=>signOut(auth));

onAuthStateChanged(auth,user=>{
  loadingDiv.style.display='none';
  if(user){
    currentUserId=user.uid;
    appDiv.style.display='block';
    authDiv.style.display='none';
    resetForm();
    loadVitals();
  } else {
    appDiv.style.display='none';
    authDiv.style.display='block';
  }
});
</script>
</body>
</html>
