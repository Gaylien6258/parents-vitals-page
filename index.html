<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vitals Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf-autotable.min.js"></script>
</head>
<body>
  <div id="loading" class="screen">Loading...</div>
  <div id="pdf-loading" class="screen" style="display:none;">Generating PDF...</div>
  <div id="error" class="screen" style="display:none;color:red;"></div>

  <div class="screen" id="auth" style="display:none;">
    <div class="auth-card">
      <h2>Please sign in</h2>
      <button id="google-login-button" class="google-btn">Sign In with Google</button>
    </div>
  </div>

  <div class="screen" id="app" style="display:none;">
    <div class="header">
      <h1>Vitals Tracker</h1>
      <button id="logout-button" class="logout-btn">Logout</button>
    </div>
    <div id="user-id-display"></div>

    <div class="content-container">
      <!-- data entry -->
      <div class="data-entry-card">
        <h2>Record Vitals</h2>
        <form id="vitals-form">
          <div class="input-group">
            <label for="patient-select">Patient:</label>
            <select id="patient-select" required>
              <option value="Mom">Mom</option>
              <option value="Dad">Dad</option>
            </select>
          </div>
          <div class="input-group"><label>Systolic BP:</label><input type="number" id="systolic" min="0" max="300"/></div>
          <div class="input-group"><label>Diastolic BP:</label><input type="number" id="diastolic" min="0" max="200"/></div>
          <div class="input-group"><label>Heart Rate:</label><input type="number" id="heartrate" min="0" max="200"/></div>
          <div class="input-group"><label>Oxygen Saturation:</label><input type="number" id="oxygen" min="0" max="100"/></div>
          <div class="input-group"><label>Blood Glucose:</label><input type="number" id="glucose" min="0" max="500"/></div>
          <div class="input-group"><label>Date and Time:</label><input type="datetime-local" id="timestamp-input" required/></div>
          <button type="submit" id="submit-btn" class="submit-btn">Add Vitals</button>
          <button type="button" id="update-btn" class="submit-btn" style="display:none;">Update Vitals</button>
          <button type="button" id="cancel-edit-btn" class="submit-btn" style="display:none;">Cancel</button>
        </form>
      </div>

      <!-- data view -->
      <div class="data-view-card">
        <h2>Vitals Over Time</h2>
        <div class="chart-container"><canvas id="vitals-chart"></canvas></div>
        <h2>Recent Readings</h2>
        <div class="input-group"><label>Start Date:</label><input type="date" id="date-range-start"/></div>
        <div class="input-group"><label>End Date:</label><input type="date" id="date-range-end"/></div>
        <button id="download-pdf" class="download-btn">Download PDF Report</button>
        <ul id="vitals-list"></ul>
      </div>
    </div>
  </div>

  <div id="confirm-modal" class="modal">
    <div class="modal-content">
      <p id="confirm-message"></p>
      <div class="modal-buttons">
        <button id="confirm-yes-btn" class="modal-btn yes">Yes</button>
        <button id="confirm-no-btn" class="modal-btn no">No</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, orderBy, query, onSnapshot, getDocs, where, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDWKz6O-5xir46vivUPBAse_vMSaXWKamU",
      authDomain: "parents-vitals-data.firebaseapp.com",
      projectId: "parents-vitals-data",
      storageBucket: "parents-vitals-data.firebasestorage.app",
      messagingSenderId: "34332288387",
      appId: "1:34332288387:web:ea67be6bb564e8f402c2b6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const { jsPDF } = window.jspdf;

    // --- DOM refs ---
    const loadingDiv = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const authDiv = document.getElementById('auth');
    const appDiv = document.getElementById('app');
    const pdfLoadingDiv = document.getElementById('pdf-loading');
    const vitalsForm = document.getElementById('vitals-form');
    const patientSelect = document.getElementById('patient-select');
    const systolicInput = document.getElementById('systolic');
    const diastolicInput = document.getElementById('diastolic');
    const heartrateInput = document.getElementById('heartrate');
    const oxygenInput = document.getElementById('oxygen');
    const glucoseInput = document.getElementById('glucose');
    const timestampInput = document.getElementById('timestamp-input');
    const vitalsList = document.getElementById('vitals-list');
    const downloadPdfButton = document.getElementById('download-pdf');
    const submitBtn = document.getElementById('submit-btn');
    const updateBtn = document.getElementById('update-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const logoutButton = document.getElementById('logout-button');
    const googleLoginButton = document.getElementById('google-login-button');
    const userIdDisplay = document.getElementById('user-id-display');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmYesBtn = document.getElementById('confirm-yes-btn');
    const confirmNoBtn = document.getElementById('confirm-no-btn');
    const dateRangeStart = document.getElementById('date-range-start');
    const dateRangeEnd = document.getElementById('date-range-end');

    let docIdToEdit = null;
    let docIdToDelete = null;
    let vitalsChart = null;
    let currentUserId = null;
    let unsubscribeVitals = null;

    const patientNames = { "Mom": "Susan", "Dad": "Gary" };

    // --- helper ---
    function showError(msg){ errorDiv.textContent = msg; errorDiv.style.display="block"; }
    function hideError(){ errorDiv.style.display="none"; }

    function validateInputs(s,d,h,o,g){
      if(d && (d<0||d>200)) return false;
      if(s && (s<0||s>300)) return false;
      if(h && (h<0||h>200)) return false;
      if(o && (o<0||o>100)) return false;
      if(g && (g<0||g>500)) return false;
      return true;
    }

    function logout(){
      signOut(auth).then(()=>{
        appDiv.style.display='none';
        authDiv.style.display='flex';
        currentUserId=null;
        userIdDisplay.textContent='';
        if(vitalsChart) vitalsChart.destroy();
        if(unsubscribeVitals) unsubscribeVitals();
      }).catch(e=>showError("Logout failed: "+e.message));
    }

    function updateChart(data){
      if(vitalsChart) vitalsChart.destroy();
      const ctx=document.getElementById('vitals-chart').getContext('2d');
      vitalsChart=new Chart(ctx,{type:'line',data:{
        datasets:[
          {label:"Heart Rate",data:data.map(d=>({x:d.timestamp.toDate(),y:d.heartrate||null})),borderColor:"#4f46e5"},
          {label:"Oxygen %",data:data.map(d=>({x:d.timestamp.toDate(),y:d.oxygen||null})),borderColor:"#10b981"},
          {label:"Glucose",data:data.map(d=>({x:d.timestamp.toDate(),y:d.glucose||null})),borderColor:"#f59e0b"}
        ]},options:{scales:{x:{type:'time',time:{unit:'day'}},y:{beginAtZero:true}}}});
    }

    function displayVitals(data){
      vitalsList.innerHTML='';
      data.forEach(v=>{
        const li=document.createElement('li');
        li.innerHTML=`
          ${patientNames[v.patient]||v.patient} - ${v.timestamp.toDate().toLocaleString()} :
          BP: ${v.systolic||'-'}/${v.diastolic||'-'}, HR:${v.heartrate||'-'}, O2:${v.oxygen||'-'}, Glu:${v.glucose||'-'}
          <div>
            <button class="edit-btn" data-id="${v.id}">Edit</button>
            <button class="delete-btn" data-id="${v.id}">Delete</button>
          </div>`;
        vitalsList.appendChild(li);
      });
      vitalsList.querySelectorAll('.edit-btn').forEach(btn=>{
        btn.onclick=async()=>{
          docIdToEdit=btn.dataset.id;
          const docRef=doc(db,'users',currentUserId,'vitals',docIdToEdit);
          const snap=await getDoc(docRef);
          const d=snap.data();
          patientSelect.value=d.patient;
          systolicInput.value=d.systolic||'';
          diastolicInput.value=d.diastolic||'';
          heartrateInput.value=d.heartrate||'';
          oxygenInput.value=d.oxygen||'';
          glucoseInput.value=d.glucose||'';
          timestampInput.value=d.timestamp.toDate().toISOString().slice(0,16);
          submitBtn.style.display='none'; updateBtn.style.display='block'; cancelEditBtn.style.display='block';
        }
      });
      vitalsList.querySelectorAll('.delete-btn').forEach(btn=>{
        btn.onclick=()=>{ docIdToDelete=btn.dataset.id; confirmMessage.textContent="Delete this entry?"; confirmModal.style.display="flex"; }
      });
    }

    function generatePDF(data){
      pdfLoadingDiv.style.display="flex";
      const pdf=new jsPDF();
      pdf.setFontSize(20); pdf.text("Vitals Report",20,20);
      pdf.setFontSize(12); pdf.text(`Generated: ${new Date().toLocaleString()}`,20,30);
      const table=data.map(v=>[patientNames[v.patient]||v.patient,v.timestamp.toDate().toLocaleString(),v.systolic?`${v.systolic}/${v.diastolic||'-'}`:'-',v.heartrate||'-',v.oxygen||'-',v.glucose||'-']);
      pdf.autoTable({head:[["Patient","Date","BP","HR","O2","Glucose"]],body:table,startY:40});
      setTimeout(()=>{ pdf.save("vitals-report.pdf"); pdfLoadingDiv.style.display="none"; },800);
    }

    // --- auth state ---
    onAuthStateChanged(auth,user=>{
      if(user){
        currentUserId=user.uid;
        userIdDisplay.textContent="Logged in as: "+user.email;
        loadingDiv.style.display='none'; authDiv.style.display='none'; appDiv.style.display='block';
        const q=query(collection(db,'users',currentUserId,'vitals'),orderBy('timestamp','desc'));
        unsubscribeVitals=onSnapshot(q,snap=>{
          const arr=[]; snap.forEach(d=>arr.push({id:d.id,...d.data()}));
          displayVitals(arr); updateChart(arr);
        },err=>showError("Fetch error: "+err.message));
      }else{
        loadingDiv.style.display='none'; authDiv.style.display='flex'; appDiv.style.display='none';
        if(unsubscribeVitals) unsubscribeVitals();
      }
    },err=>{showError("Auth init error: "+err.message); loadingDiv.style.display='none'; authDiv.style.display='flex';});

    // --- events ---
    googleLoginButton.onclick=async()=>{
      try{await signInWithPopup(auth,new GoogleAuthProvider());}catch(e){showError("Login failed: "+e.message);}
    };
    logoutButton.onclick=logout;

    vitalsForm.onsubmit=async e=>{
      e.preventDefault();
      const s=parseInt(systolicInput.value)||null;
      const d=parseInt(diastolicInput.value)||null;
      const h=parseInt(heartrateInput.value)||null;
      const o=parseInt(oxygenInput.value)||null;
      const g=parseInt(glucoseInput.value)||null;
      const t=new Date(timestampInput.value);
      if(!validateInputs(s,d,h,o,g)) return showError("Invalid values");
      try{
        await addDoc(collection(db,'users',currentUserId,'vitals'),{patient:patientSelect.value,systolic:s,diastolic:d,heartrate:h,oxygen:o,glucose:g,timestamp:Timestamp.fromDate(t)});
        vitalsForm.reset(); hideError();
      }catch(e){showError("Add error: "+e.message);}
    };

    updateBtn.onclick=async()=>{
      const s=parseInt(systolicInput.value)||null;
      const d=parseInt(diastolicInput.value)||null;
      const h=parseInt(heartrateInput.value)||null;
      const o=parseInt(oxygenInput.value)||null;
      const g=parseInt(glucoseInput.value)||null;
      const t=new Date(timestampInput.value);
      if(!validateInputs(s,d,h,o,g)) return showError("Invalid values");
      try{
        await updateDoc(doc(db,'users',currentUserId,'vitals',docIdToEdit),{patient:patientSelect.value,systolic:s,diastolic:d,heartrate:h,oxygen:o,glucose:g,timestamp:Timestamp.fromDate(t)});
        vitalsForm.reset(); submitBtn.style.display='block'; updateBtn.style.display='none'; cancelEditBtn.style.display='none'; docIdToEdit=null; hideError();
      }catch(e){showError("Update error: "+e.message);}
    };
    cancelEditBtn.onclick=()=>{vitalsForm.reset(); submitBtn.style.display='block'; updateBtn.style.display='none'; cancelEditBtn.style.display='none'; docIdToEdit=null; hideError();};

    confirmYesBtn.onclick=async()=>{ try{await deleteDoc(doc(db,'users',currentUserId,'vitals',docIdToDelete)); confirmModal.style.display='none'; docIdToDelete=null;}catch(e){showError("Delete error: "+e.message);} };
    confirmNoBtn.onclick=()=>{confirmModal.style.display='none'; docIdToDelete=null;};

    downloadPdfButton.onclick=async()=>{
      let q=query(collection(db,'users',currentUserId,'vitals'),orderBy('timestamp','desc'));
      const start=dateRangeStart.value?new Date(dateRangeStart.value):null;
      const end=dateRangeEnd.value?new Date(dateRangeEnd.value):null;
      if(start) q=query(q,where('timestamp','>=',Timestamp.fromDate(start)));
      if(end){end.setHours(23,59,59,999); q=query(q,where('timestamp','<=',Timestamp.fromDate(end)));}
      const snap=await getDocs(q); const arr=[]; snap.forEach(d=>arr.push(d.data())); generatePDF(arr);
    };
  </script>
</body>
</html>
