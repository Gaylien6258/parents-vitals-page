<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vitals Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="styles.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf-autotable.min.js"></script>
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, orderBy, query, onSnapshot, getDocs, where, Timestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';
import { GoogleAuthProvider as GoogleAuthProviderCompat } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js';

const firebaseConfig = {
    apiKey: "AIzaSyDWKz6O-5xir46vivUPBAse_vMSaXWKamU",
    authDomain: "parents-vitals-data.firebaseapp.com",
    projectId: "parents-vitals-data",
    storageBucket: "parents-vitals-data.firebasestorage.app",
    messagingSenderId: "34332288387",
    appId: "1:34332288387:web:ea67be6bb564e8f402c2b6"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const { jsPDF } = window.jspdf;

const loadingDiv = document.getElementById('loading');
const errorDiv = document.getElementById('error');
const authDiv = document.getElementById('auth');
const appDiv = document.getElementById('app');
const pdfLoadingDiv = document.getElementById('pdf-loading');

const vitalsForm = document.getElementById('vitals-form');
const patientSelect = document.getElementById('patient-select');
const systolicInput = document.getElementById('systolic');
const diastolicInput = document.getElementById('diastolic');
const heartrateInput = document.getElementById('heartrate');
const oxygenInput = document.getElementById('oxygen');
const glucoseInput = document.getElementById('glucose');
const timestampInput = document.getElementById('timestamp-input');
const vitalsList = document.getElementById('vitals-list');
const downloadPdfButton = document.getElementById('download-pdf');
const submitBtn = document.getElementById('submit-btn');
const updateBtn = document.getElementById('update-btn');
const cancelEditBtn = document.getElementById('cancel-edit-btn');
const logoutButton = document.getElementById('logout-button');
const googleLoginButton = document.getElementById('google-login-button');
const confirmModal = document.getElementById('confirm-modal');
const confirmMessage = document.getElementById('confirm-message');
const confirmYesBtn = document.getElementById('confirm-yes-btn');
const confirmNoBtn = document.getElementById('confirm-no-btn');
const dateRangeStart = document.getElementById('date-range-start');
const dateRangeEnd = document.getElementById('date-range-end');

let docIdToEdit = null;
let docIdToDelete = null;
let currentUserId = null;
let unsubscribeVitals = null;

const patientNames = { "Mom": "Susan", "Dad": "Gary" };

function validateInputs(systolic, diastolic, heartrate, oxygen, glucose) {
    if (systolic && (systolic < 0 || systolic > 300)) return false;
    if (diastolic && (diastolic < 0 || diastolic > 200)) return false;
    if (heartrate && (heartrate < 0 || heartrate > 200)) return false;
    if (oxygen && (oxygen < 0 || oxygen > 100)) return false;
    if (glucose && (glucose < 0 || glucose > 500)) return false;
    return true;
}

function logout() {
    signOut(auth).then(() => {
        appDiv.style.display = 'none';
        authDiv.style.display = 'flex';
        currentUserId = null;
        if (unsubscribeVitals) unsubscribeVitals();
    }).catch(error => {
        errorDiv.textContent = 'Logout failed: ' + error.message;
        errorDiv.style.display = 'block';
    });
}

function displayVitals(data) {
    vitalsList.innerHTML = '';
    data.forEach(doc => {
        const vital = doc.data();
        const li = document.createElement('li');
        li.innerHTML = `
            ${patientNames[vital.patient] || vital.patient} - 
            ${vital.timestamp.toDate().toLocaleString()}: 
            BP: ${vital.systolic || '-'} / ${vital.diastolic || '-'} mmHg, 
            HR: ${vital.heartrate || '-'} bpm, 
            O2: ${vital.oxygen || '-'}%, 
            Glucose: ${vital.glucose || '-'} mg/dL
            <div>
                <button class="edit-btn" data-id="${doc.id}">Edit</button>
                <button class="delete-btn" data-id="${doc.id}">Delete</button>
            </div>
        `;
        vitalsList.appendChild(li);
    });

    vitalsList.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            docIdToEdit = btn.dataset.id;
            const docRef = doc(db, 'users', currentUserId, 'vitals', docIdToEdit);
            getDocs(docRef).then(fetchedDoc => {
                const data = fetchedDoc.data();
                patientSelect.value = data.patient;
                systolicInput.value = data.systolic || '';
                diastolicInput.value = data.diastolic || '';
                heartrateInput.value = data.heartrate || '';
                oxygenInput.value = data.oxygen || '';
                glucoseInput.value = data.glucose || '';
                timestampInput.value = data.timestamp.toDate().toISOString().slice(0,16);
                submitBtn.style.display = 'none';
                updateBtn.style.display = 'block';
                cancelEditBtn.style.display = 'block';
            }).catch(error => {
                errorDiv.textContent = 'Error loading vital: ' + error.message;
                errorDiv.style.display = 'block';
            });
        });
    });

    vitalsList.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            docIdToDelete = btn.dataset.id;
            confirmMessage.textContent = 'Are you sure you want to delete this entry?';
            confirmModal.style.display = 'flex';
        });
    });
}

onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUserId = user.uid;
        loadingDiv.style.display = 'none';
        authDiv.style.display = 'none';
        appDiv.style.display = 'block';

        const vitalsCol = collection(db, 'users', currentUserId, 'vitals');
        const q = query(vitalsCol, orderBy('timestamp', 'desc'));
        unsubscribeVitals = onSnapshot(q, (snapshot) => {
            let data = [];
            snapshot.forEach((fetchedDoc) => data.push({ id: fetchedDoc.id, ...fetchedDoc.data() }));
            // Filter by patient
            data = data.filter(d => d.patient === patientSelect.value);
            // Filter by date range
            if (dateRangeStart.value) data = data.filter(d => d.timestamp.toDate() >= new Date(dateRangeStart.value));
            if (dateRangeEnd.value) {
                let end = new Date(dateRangeEnd.value);
                end.setHours(23,59,59,999);
                data = data.filter(d => d.timestamp.toDate() <= end);
            }
            displayVitals(data);
        }, (error) => {
            errorDiv.textContent = 'Error fetching vitals: ' + error.message;
            errorDiv.style.display = 'block';
        });
    } else {
        loadingDiv.style.display = 'none';
        authDiv.style.display = 'flex';
        appDiv.style.display = 'none';
        if (unsubscribeVitals) {
            unsubscribeVitals();
            unsubscribeVitals = null;
        }
    }
}, (error) => {
    errorDiv.textContent = 'Auth initialization error: ' + error.message;
    errorDiv.style.display = 'block';
    loadingDiv.style.display = 'none';
    authDiv.style.display = 'flex';
});

googleLoginButton.addEventListener('click', async () => {
    const provider = new GoogleAuthProviderCompat();
    try { await signInWithPopup(auth, provider); }
    catch (error) { errorDiv.textContent = 'Login failed: ' + error.message; errorDiv.style.display = 'block'; }
});

logoutButton.addEventListener('click', logout);

vitalsForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const systolic = parseInt(systolicInput.value)||null;
    const diastolic = parseInt(diastolicInput.value)||null;
    const heartrate = parseInt(heartrateInput.value)||null;
    const oxygen = parseInt(oxygenInput.value)||null;
    const glucose = parseInt(glucoseInput.value)||null;
    const timestamp = new Date(timestampInput.value);
    if(!validateInputs(systolic,diastolic,heartrate,oxygen,glucose)){
        errorDiv.textContent='Invalid values.';
        errorDiv.style.display='block';
        return;
    }
    try{
        const vitalsCol=collection(db,'users',currentUserId,'vitals');
        await addDoc(vitalsCol,{userId:currentUserId,patient:patientSelect.value,systolic,diastolic,heartrate,oxygen,glucose,timestamp:Timestamp.fromDate(timestamp)});
        vitalsForm.reset();
        errorDiv.style.display='none';
    }catch(error){
        errorDiv.textContent='Error adding vitals: '+error.message;
        errorDiv.style.display='block';
    }
});

updateBtn.addEventListener('click', async()=>{
    const systolic = parseInt(systolicInput.value)||null;
    const diastolic = parseInt(diastolicInput.value)||null;
    const heartrate = parseInt(heartrateInput.value)||null;
    const oxygen = parseInt(oxygenInput.value)||null;
    const glucose = parseInt(glucoseInput.value)||null;
    const timestamp = new Date(timestampInput.value);
    if(!validateInputs(systolic,diastolic,heartrate,oxygen,glucose)){
        errorDiv.textContent='Invalid values.';
        errorDiv.style.display='block';
        return;
    }
    try{
        const docRef=doc(db,'users',currentUserId,'vitals',docIdToEdit);
        await updateDoc(docRef,{patient:patientSelect.value,systolic,diastolic,heartrate,oxygen,glucose,timestamp:Timestamp.fromDate(timestamp)});
        vitalsForm.reset();
        submitBtn.style.display='block';
        updateBtn.style.display='none';
        cancelEditBtn.style.display='none';
        docIdToEdit=null;
        errorDiv.style.display='none';
    }catch(error){
        errorDiv.textContent='Error updating vitals: '+error.message;
        errorDiv.style.display='block';
    }
});

cancelEditBtn.addEventListener('click', ()=>{
    vitalsForm.reset();
    submitBtn.style.display='block';
    updateBtn.style.display='none';
    cancelEditBtn.style.display='none';
    docIdToEdit=null;
    errorDiv.style.display='none';
});

confirmYesBtn.addEventListener('click', async()=>{
    try{
        const docRef=doc(db,'users',currentUserId,'vitals',docIdToDelete);
        await deleteDoc(docRef);
        confirmModal.style.display='none';
        docIdToDelete=null;
        errorDiv.style.display='none';
    }catch(error){
        errorDiv.textContent='Error deleting vital: '+error.message;
        errorDiv.style.display='block';
    }
});

confirmNoBtn.addEventListener('click',()=>{
    confirmModal.style.display='none';
    docIdToDelete=null;
    errorDiv.style.display='none';
});

patientSelect.addEventListener('change',()=>{
    // Trigger snapshot to re-filter recent entries by patient
    if(unsubscribeVitals) unsubscribeVitals();
    onAuthStateChanged(auth,(user)=>{
        if(user){
            currentUserId=user.uid;
            const vitalsCol=collection(db,'users',currentUserId,'vitals');
            const q=query(vitalsCol,orderBy('timestamp','desc'));
            unsubscribeVitals=onSnapshot(q,(snapshot)=>{
                let data=[];
                snapshot.forEach(fetchedDoc=>data.push({id:fetchedDoc.id,...fetchedDoc.data()}));
                data=data.filter(d=>d.patient===patientSelect.value);
                if(dateRangeStart.value) data=data.filter(d=>d.timestamp.toDate()>=new Date(dateRangeStart.value));
                if(dateRangeEnd.value){let end=new Date(dateRangeEnd.value);end.setHours(23,59,59,999);data=data.filter(d=>d.timestamp.toDate()<=end);}
                displayVitals(data);
            });
        }
    });
});

dateRangeStart.addEventListener('change',()=>patientSelect.dispatchEvent(new Event('change')));
dateRangeEnd.addEventListener('change',()=>patientSelect.dispatchEvent(new Event('change')));

downloadPdfButton.addEventListener('click', async()=>{
    pdfLoadingDiv.style.display='flex';
    const startDate=dateRangeStart.value?new Date(dateRangeStart.value):null;
    const endDate=dateRangeEnd.value?new Date(dateRangeEnd.value):null;
    let q=query(collection(db,'users',currentUserId,'vitals'),orderBy('timestamp','desc'));
    if(startDate) q=query(q,where('timestamp','>=',Timestamp.fromDate(startDate)));
    if(endDate){let end=new Date(endDate);end.setHours(23,59,59,999);q=query(q,where('timestamp','<=',Timestamp.fromDate(end)));}
    q=query(q,where('patient','==',patientSelect.value));
    try{
        const snapshot=await getDocs(q);
        const data=[];
        snapshot.forEach(fetchedDoc=>data.push(fetchedDoc.data()));
        generatePDF(data);
    }catch(error){
        errorDiv.textContent='Error generating PDF: '+error.message;
        errorDiv.style.display='block';
        pdfLoadingDiv.style.display='none';
    }
});

function generatePDF(data){
    const doc=new jsPDF();
    doc.setFontSize(20);doc.text('Vitals Report',20,20);
    doc.setFontSize(12);doc.text(`Generated on: ${new Date().toLocaleString()}`,20,30);
    doc.text(`Patient: ${patientNames[patientSelect.value]||patientSelect.value}`,20,40);
    const tableData=data.map(vital=>[vital.timestamp.toDate().toLocaleString(),`${vital.systolic||'-'}/${vital.diastolic||'-'}`,vital.heartrate||'-',vital.oxygen||'-',vital.glucose||'-']);
    doc.autoTable({head:[['Date','Blood Pressure','Heart Rate','Oxygen','Glucose']],body:tableData,startY:50,styles:{fontSize:10},headStyles:{fillColor:[79,70,229]}});
    setTimeout(()=>{doc.save('vitals-report.pdf');pdfLoadingDiv.style.display='none';},500);
}
</script>
</head>
<body>
<div id="loading" class="screen">Loading...</div>
<div id="pdf-loading" class="screen" style="display:none;">Generating PDF...</div>
<div id="error" class="screen" style="display:none;color:red;"></div>

<div class="screen" id="auth" style="display:none;">
    <div class="auth-card">
        <h2>Please sign in</h2>
        <button id="google-login-button" class="google-btn">Sign In with Google</button>
    </div>
</div>

<div class="screen" id="app" style="display:none;">
    <div class="header"><h1>Vitals Tracker</h1><button id="logout-button" class="logout-btn">Logout</button></div>
    <div class="content-container">
        <div class="data-entry-card">
            <h2>Record Vitals</h2>
            <form id="vitals-form">
                <div class="input-group"><label for="patient-select">Patient:</label><select id="patient-select" required><option value="Mom">Mom</option><option value="Dad">Dad</option></select></div>
                <div class="input-group"><label for="systolic">Systolic BP (mmHg):</label><input type="number" id="systolic" placeholder="Systolic" min="0" max="300"></div>
                <div class="input-group"><label for="diastolic">Diastolic BP (mmHg):</label><input type="number" id="diastolic" placeholder="Diastolic" min="0" max="200"></div>
                <div class="input-group"><label for="heartrate">Heart Rate (bpm):</label><input type="number" id="heartrate" placeholder="Heart Rate" min="0" max="200"></div>
                <div class="input-group"><label for="oxygen">Oxygen Saturation (%):</label><input type="number" id="oxygen" placeholder="Oxygen Saturation" min="0" max="100"></div>
                <div class="input-group"><label for="glucose">Blood Glucose (mg/dL):</label><input type="number" id="glucose" placeholder="Blood Glucose" min="0" max="500"></div>
                <div class="input-group"><label for="timestamp-input">Date and Time:</label><input type="datetime-local" id="timestamp-input" required></div>
                <button type="submit" id="submit-btn" class="submit-btn">Add Vitals</button>
                <button type="button" id="update-btn" class="submit-btn" style="display:none;">Update Vitals</button>
                <button type="button" id="cancel-edit-btn" class="submit-btn" style="display:none;">Cancel</button>
            </form>
        </div>

        <div class="data-view-card">
            <h2>Recent Readings</h2>
            <div class="input-group"><label for="date-range-start">Start Date:</label><input type="date" id="date-range-start"></div>
            <div class="input-group"><label for="date-range-end">End Date:</label><input type="date" id="date-range-end"></div>
            <button id="download-pdf" class="download-btn">Download PDF Report</button>
            <ul id="vitals-list"></ul>
        </div>
    </div>
</div>

<div id="confirm-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <p id="confirm-message"></p>
        <button id="confirm-yes-btn">Yes</button>
        <button id="confirm-no-btn">No</button>
    </div>
</div>
</body>
</html>
